# alertmanager-webhook-servicenow
[![Build Status](https://travis-ci.org/FXinnovation/alertmanager-webhook-servicenow.svg?branch=master)](https://travis-ci.org/FXinnovation/alertmanager-webhook-servicenow)

A [Prometheus AlertManager](https://github.com/prometheus/alertmanager) webhook receiver that manages [ServiceNow](https://www.servicenow.com) incidents from alerts, written in Go.

## Current features
### ServiceNow authentication
The supported authentication to ServiceNow is through a service account (basic authentication through HTTPS).

### Creation of incident by group of alerts
One incident is created per distinct group key â€” as defined by the [`group_by`](https://prometheus.io/docs/alerting/configuration/#<route>) parameter of Alertmanager's `route` configuration section. This avoid spamming ServiceNow with incidents when a huge system failure occurs, and still provide a very flexible mechanism to group alerts in one incident.

Currently, each AlertManager's notification group to the webhook will create a new incident, so configure the [`repeat_interval`](https://prometheus.io/docs/alerting/configuration/#<route>) accordingly.

## Planned features
- Update an existing incident if it already exists, for both firing and resolved status
- Provide more advanced incident configuration (fields override, fields templating, etc...)

## Getting Started

### Prerequisites
To run this project, you will need a [working Go environment](https://golang.org/doc/install).

### Installing
```bash
go get -u github.com/FXinnovation/alertmanager-webhook-servicenow
```

## Testing
This webhook expects a JSON object from Alertmanager. The format of this JSON is described in the [Alertmanager documentation](https://prometheus.io/docs/alerting/configuration/#<webhook_config>) or, alternatively, in the [Alertmanager GoDoc](https://godoc.org/github.com/prometheus/alertmanager/template#Data).

### Manual testing
To quickly test if the webhook is working you can run:

```bash
curl -H "Content-type: application/json" -X POST \
  -d '{"receiver": "servicenow-receiver-1", "status": "firing", "externalURL":"http://my.url", "alerts": [{"status": "firing", "labels": {"alertname": "TestAlert"}, "annotations":{"summary": "My alert summary", "description": "My alert description"} }], "groupLabels": {"alertname": "TestAlert"}}' \
  http://localhost:9877/webhook
```

### Running unit tests
```bash
make test
```

## Usage
```bash
./alertmanager-webhook-servicenow -h
```

## Deployment
The webhook listen on port 9877 by default.

### alertmanager-webhook-servicenow config
The webhook config is done in `config/servicenow.yml`

```
service_now:
  instance_name: "<instance name>"
  user_name: "<user>"
  password: "<password>"

default_incident:
  # Sysid or name of the assignment group
  assignment_group: "<assignment group>"
  # Impact: Business loss and potential damage (for example, financial, customer, regulation, security, reputation, brand) caused by the incident
  # Common values: 1 (High), 2 (Medium), 3 (Low)
  impact: 2
  # Urgency: Speed at which the business expects the incident to be resolved
  # Common values: 1 (High), 2 (Medium), 3 (Low)
  urgency: 2
```

Other incident fields (Shord description, Description, Comment) are currently auto-generated by the webhook.

### AlertManager config
In the AlertManager config (e.g., alertmanager.yml), a `webhook_configs` target the webhook URL, e.g.:

```
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'client']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'servicenow-receiver-1'

receivers:
- name: 'servicenow-receiver-1'
  webhook_configs:
  - url: "http://localhost:9877/webhook"
    send_resolved: true
```


## Docker image
You can build a docker image using:
```bash
make docker
```
The resulting image is named `fxinnovation/alertmanager-webhook-servicenow:{git-branch}`.
It exposes port 9877 and expects the config in /config/servicenow.yml. To configure it, you can bind-mount a config from your host: 

```
$ docker run -p 9877 -v /path/on/host/config/servicenow.yml:/config/servicenow.yml fxinnovation/alertmanager-webhook-servicenow:master
```

## Contributing
Refer to [CONTRIBUTING.md](https://github.com/FXinnovation/alertmanager-webhook-servicenow/blob/master/CONTRIBUTING.md).

## License
Apache License 2.0, see [LICENSE](https://github.com/FXinnovation/alertmanager-webhook-servicenow/blob/master/LICENSE).
